name: G√©n√©ration README automatique

on:
  schedule:
    - cron: "0 */6 * * *" # Toutes les 6h au lieu de chaque push
    - cron: "0 2 * * *"


permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: G√©n√©rer index des contributions
        run: |
          cat > INDEX.md << EOF
          # Index des Contributions

          *G√©n√©r√© automatiquement le $(date)*

          ## üìä Statistiques
          - Scripts: $(find scripts -name "*.py" -o -name "*.sh" -o -name "*.js" | wc -l)
          - Exemples: $(find examples -mindepth 2 -name "README.md" | wc -l)
          - Configurations: $(find configs -name "*" -type f | wc -l)

          ## üêç Scripts Python
          EOF

          find scripts/python -name "*.py" -exec basename {} \; | sort >> INDEX.md

          echo -e "\n## üîß Scripts Bash" >> INDEX.md
          find scripts/bash -name "*.sh" -exec basename {} \; | sort >> INDEX.md

          echo -e "\n## ‚öôÔ∏è Automatisation" >> INDEX.md
          find scripts/automation -name "*" -type f -exec basename {} \; | sort >> INDEX.md

      - name: Commit et push INDEX.md
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Pull des derniers changements pour √©viter conflits
          git pull origin main || true

          # Reg√©n√©rer INDEX.md avec les derniers chiffres
          cat > INDEX.md << EOF
          # Index des Contributions

          *G√©n√©r√© automatiquement le $(date)*

          ## üìä Statistiques
          - Scripts: $(find scripts -name "*.py" -o -name "*.sh" -o -name "*.js" | wc -l)
          - Exemples: $(find examples -mindepth 2 -name "README.md" | wc -l)
          - Configurations: $(find configs -name "*" -type f | wc -l)

          ## üêç Scripts Python
          $(find scripts/python -name "*.py" -exec basename {} \; | grep -v __pycache__ | sort)

          ## üîß Scripts Bash
          $(find scripts/bash -name "*.sh" -exec basename {} \; | sort)

          ## ‚öôÔ∏è Automatisation
          README.md
          EOF

          git add INDEX.md
          if ! git diff --staged --quiet; then
            git commit -m "docs: mise √† jour automatique de l'index [skip ci]"
            git push || echo "Push √©chou√© - permissions insuffisantes"
            echo "README_UPDATED=true" >> $GITHUB_ENV
          fi

      - name: Cr√©er commentaire de notification
        if: env.README_UPDATED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Cr√©er un issue pour notifier de la mise √† jour
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìä Index automatiquement mis √† jour',
              body: `L'index des contributions a √©t√© mis √† jour automatiquement le ${new Date().toLocaleString('fr-FR')}.
              
              Consultez le fichier [INDEX.md](./INDEX.md) pour voir les derni√®res statistiques.`,
              labels: ['documentation', 'automated']
            });
